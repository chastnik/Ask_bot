#!/bin/bash

# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ° ÐºÐ¾Ð¼Ð¿Ð»ÐµÐºÑÐ½Ð¾Ð³Ð¾ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ask Bot

echo "ðŸš€ Ask Bot - ÐšÐ¾Ð¼Ð¿Ð»ÐµÐºÑÐ½Ð¾Ðµ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ"
echo "======================================"
echo ""

# ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒ ÐµÑÐ»Ð¸ Ð·Ð°Ð¿Ñ€Ð¾ÑˆÐµÐ½Ð°
if [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
    echo "ðŸ“– Ð˜Ð¡ÐŸÐžÐ›Ð¬Ð—ÐžÐ’ÐÐÐ˜Ð•:"
    echo "   ./run_tests.sh           - Ð˜Ð½Ñ‚ÐµÑ€Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ð¹ Ñ€ÐµÐ¶Ð¸Ð¼"
    echo "   ./run_tests.sh --auth    - Ð¡ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸ÐµÐ¹ Ð² Jira" 
    echo "   ./run_tests.sh --no-auth - Ð‘ÐµÐ· Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ð¸ (Ð±Ð°Ð·Ð¾Ð²Ñ‹Ðµ Ñ‚ÐµÑÑ‚Ñ‹)"
    echo ""
    echo "ðŸ“‹ ÐŸÐ Ð¯ÐœÐžÐ™ Ð—ÐÐŸÐ£Ð¡Ðš:"
    echo "   python3 test_bot_comprehensive.py --auth"
    echo "   python3 test_bot_comprehensive.py --login user --password pass"
    echo "   python3 test_bot_comprehensive.py --no-auth"
    echo ""
    exit 0
fi

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð°Ñ ÑÑ€ÐµÐ´Ð° Ð°ÐºÑ‚Ð¸Ð²Ð½Ð°
if [[ "$VIRTUAL_ENV" == "" ]]; then
    echo "âš ï¸  Ð’Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð°Ñ ÑÑ€ÐµÐ´Ð° Ð½Ðµ Ð°ÐºÑ‚Ð¸Ð²Ð½Ð°. ÐÐºÑ‚Ð¸Ð²Ð¸Ñ€ÑƒÐµÐ¼..."
    source venv/bin/activate
fi

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ Ð±Ð¾Ñ‚ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½
echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ Ð±Ð¾Ñ‚ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½..."
curl -s http://localhost:8000/health > /dev/null
if [ $? -ne 0 ]; then
    echo "âŒ Ð‘Ð¾Ñ‚ Ð½Ðµ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½! Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ Ð±Ð¾Ñ‚ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð¾Ð¹:"
    echo "   ./scripts/run.sh"
    echo ""
    exit 1
fi

echo "âœ… Ð‘Ð¾Ñ‚ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚"
echo ""

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
echo "ðŸ“¦ ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸..."
python3 -c "import asyncio, json" 2>/dev/null
if [ $? -ne 0 ]; then
    echo "âŒ ÐžÑ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‚ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸"
    exit 1
fi

echo "âœ… Ð—Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð³Ð¾Ñ‚Ð¾Ð²Ñ‹"
echo ""

# Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ñ‚ÐµÑÑ‚Ñ‹
echo "ðŸ§ª Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÐºÐ¾Ð¼Ð¿Ð»ÐµÐºÑÐ½Ð¾Ðµ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ..."
echo ""

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð°Ñ€Ð³ÑƒÐ¼ÐµÐ½Ñ‚Ñ‹
if [ "$1" = "--auth" ] || [ "$1" = "-a" ]; then
    echo "ðŸ” Ð—Ð°Ð¿ÑƒÑÐº Ñ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸ÐµÐ¹ Ð² Jira..."
    python3 test_bot_comprehensive.py --auth
elif [ "$1" = "--no-auth" ] || [ "$1" = "-n" ]; then
    echo "âš¡ Ð—Ð°Ð¿ÑƒÑÐº Ð±ÐµÐ· Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ð¸ (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð±Ð°Ð·Ð¾Ð²Ñ‹Ðµ Ñ‚ÐµÑÑ‚Ñ‹)..."
    python3 test_bot_comprehensive.py --no-auth
else
    echo "ðŸ’¡ Ð—Ð°Ð¿ÑƒÑÐº Ð² Ð¸Ð½Ñ‚ÐµÑ€Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¾Ð¼ Ñ€ÐµÐ¶Ð¸Ð¼Ðµ..."
    python3 test_bot_comprehensive.py
fi

TEST_RESULT=$?

echo ""
echo "======================================"

if [ $TEST_RESULT -eq 0 ]; then
    echo "ðŸŽ‰ Ð¢Ð•Ð¡Ð¢Ð˜Ð ÐžÐ’ÐÐÐ˜Ð• Ð—ÐÐ’Ð•Ð Ð¨Ð•ÐÐž Ð£Ð¡ÐŸÐ•Ð¨ÐÐž!"
    echo "   Ð’ÑÐµ Ñ‚ÐµÑÑ‚Ñ‹ Ð¿Ñ€Ð¾ÑˆÐ»Ð¸ âœ…"
else
    echo "âš ï¸  Ð¢Ð•Ð¡Ð¢Ð˜Ð ÐžÐ’ÐÐÐ˜Ð• Ð—ÐÐ’Ð•Ð Ð¨Ð•ÐÐž Ð¡ ÐžÐ¨Ð˜Ð‘ÐšÐÐœÐ˜"
    echo "   ÐÐµÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ñ‚ÐµÑÑ‚Ñ‹ Ð¿Ñ€Ð¾Ð²Ð°Ð»Ð¸Ð»Ð¸ÑÑŒ âŒ"
    echo ""
    echo "ðŸ’¡ Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ð¸:"
    echo "   â€¢ ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð»Ð¾Ð³Ð¸: tail -f logs/askbot.log"
    echo "   â€¢ Ð£Ð±ÐµÐ´Ð¸Ñ‚ÐµÑÑŒ Ñ‡Ñ‚Ð¾ Ð²Ñ‹ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð¾Ð²Ð°Ð½Ñ‹ Ð² Jira"
    echo "   â€¢ ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ð² test_results_*.json"
fi

echo ""
echo "ðŸ“Š Ð¤Ð°Ð¹Ð»Ñ‹ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð²:"
ls -la test_results_*.json 2>/dev/null | tail -3

exit $TEST_RESULT
